# Parcellation

## Subcortical

`indexTable.csv` is fetched from: https://github.com/PennLINC/xcpEngine/tree/master/atlas/TianSubcortexS2x3T and then modified to replace "-" with "_", avoiding R confusion (when reading the file, R will treat "-" as "."). This corresponds to TianSubcortexS2x3T parcellation. `TianSubcorx3TNodeNames.txt`, `TianSubcortexS2x3TMNI.nii.gz` is fetched from the same repo. \
Because our fMRI format follows `/data/nil-external/dcl/Events152_fMRI_NeuralMechanisms/fmriprep/fmriprep/sub-18/func/sub-18_task-movie_run-2_space-MNI152NLin2009cAsym_boldref.nii.gz`, we need to resample the `TianSubcortexS2x3TMNI.nii.gz` to match the fMRI space. This is done using the following code: \

```
afni.path <- "/usr/local/pkg/afni_22/";   # path to the afni function executables on ccplinux1
example image with desired output dimensions
ex.fname <- "/data/nil-external/dcl/Events152_fMRI_NeuralMechanisms/fmriprep/fmriprep/sub-18/func/sub-18_task-movie_run-2_space-MNI152NLin2009cAsym_boldref.nii.gz"
in.fname <- "/data/nil-external/dcl/Events152_fMRI_NeuralMechanisms/voxelwiseAnalyses/TianSubcortexS2x3TMNI.nii.gz";
out.fname <- "/data/nil-external/dcl/Events152_fMRI_NeuralMechanisms/voxelwiseAnalyses/TianSubcortexS2x3TMNI_94x111x94.nii.gz";  # filename of resampled subcortical
system2(paste0(afni.path, "3dresample"), args=paste0("-master ", ex.fname, " -prefix ", out.fname, " -inset ", in.fname), stdout=TRUE);
```

## Cortex

There is a difference between XCP and ThomasYesLab parcellation (Schaefer)
We use XCP to process fmriprep time-series, XCP output for each run and each subject is a matrix with 400 columns, each corresponding to a parcel. The network name, parcel name, parcel order given by XCP is here: https://github.com/PennLINC/xcpEngine/blob/master/atlas/schaefer400x7/schaefer400x7NodeNames.txt. An example of a parcel name is `7Networks_LH_Cont_PFCl_2` (7 networks parcellation, this parcel belongs to the left hemisphere, the control network - network name, and lateral PFC - component name, component number 2 out of 9 parcels within the lateral PFC, it's in line 135 meaning parcel number is 135/400). \
However, when we want to plot correlations (between timeseries and visual/segmentation features), we use a resampled version (Schaefer2018_400x7_94x111x94.nii.gz) of this https://github.com/ThomasYeoLab/CBIG/blob/master/stable_projects/brain_parcellation/Schaefer2018_LocalGlobal/Parcellations/MNI/Schaefer2018_400Parcels_7Networks_order_FSLMNI152_1mm.nii.gz. The network name, parcel name, parcel order given by this parcellation is here: https://github.com/ThomasYeoLab/CBIG/blob/master/stable_projects/brain_parcellation/Schaefer2018_LocalGlobal/Parcellations/HCP/fslr32k/cifti/Schaefer2018_400Parcels_7Networks_order_info.txt

The two parcel name files are different. XCP seems to be using an old (and wrong) version. ThomasYeoLab gave a table of component name changes, a table of component number changes, and a table of network name changes here: https://github.com/ThomasYeoLab/CBIG/tree/master/stable_projects/brain_parcellation/Schaefer2018_LocalGlobal/Parcellations/Updates.
My understanding is that as long as there is no network name change, parcel order is the same, meaning that if I take parcel number 135-th from XCP output and map it to parcel number 135-th from Schaefer2018_400x7_94x111x94.nii.gz, the mapping is still right. Quoted from ThomasYeoLab: \
"The network name was changed for a small number of parcels in higher-resolution Schaefer parcellations (usually those near the network boundaries). In this case we will reorder the Schaefer parcellation ordering so that the parcels within the same network will be grouped together. For example, for the 900-region 7-network Schaefer parcellation, 7Networks_LH_DorsAttn_FEF_1 has been changed to 7Networks_LH_Cont_PFCd_1, the index of this parcel is changed from 205 to 305."

For the 400x7 parcellation, there is no network name change, only component name change (e.g. 
7Networks_LH_Cont_PFCl_1 to 7Networks_LH_Cont_OFC_1) and component number change (e.g. 7Networks_LH_Cont_PFCl_2 to 7Networks_LH_Cont_PFCl_1). So, it means that I can just use the updated component names and numbers from https://github.com/ThomasYeoLab/CBIG/blob/master/stable_projects/brain_parcellation/Schaefer2018_LocalGlobal/Parcellations/HCP/fslr32k/cifti/Schaefer2018_400Parcels_7Networks_order_info.txt instead of https://github.com/PennLINC/xcpEngine/blob/master/atlas/schaefer400x7/schaefer400x7NodeNames.txt for parcels generated by XCP. The updated nodename file is: `atlas/schaefer400x7NodeNames_updated.txt`

# Visualization

`atlas/HCP_S1200T1w_94x111x94.nii.gz` is used as an under_img for plotting both cortex and subcortical parcels. It is obtained by resampling this `/scratch2/JoEtzel/MARCER/acqPilots_preproc/HCP_S1200T1w_MARCER3p0.nii.gz` to match the fMRI space. This is done using the same code above.