Specifically how files in this directory are used for hypothesis testing is described in the master README.md. This README is a technical supplementary 

# Prepare input to AFNI
## Prepare regressors, masking list, and scale/lpi-orient data
To prepare input to AFNI to run FIR, we need to prepare 6 motion regressors, a list of TRs that should be masked because they have high framewise displacement (FD), and voxel BOLD timeseries that are blurred, scaled, and lpi-oriented from fmriprep data. \
`voxelwiseAnalyses/finite_impulse_response/StroopCW_PreGLM_2023.03.17.sh` was copied from `/data/nil-bluearc/ccp-hcp/StroopCW/CODE/StroopCW_PreGLM_2023.03.17.sh` \
Then, a copy was made and adapted to work with our fmriprep data. `voxelwiseAnalyses/finite_impulse_response/StroopCW_PreGLM_2023.03.17 - Copy.sh` \
A version that doesn't perform spatial blur for each voxel is in `voxelwiseAnalyses/finite_impulse_response/e152_PreGLM_noBlur.sh`. The reason we don't perform spatial smoothing at this step is because we will perform statistics at the parcel level, averaging voxels within a parcel (so we will perform "spatial smoothing" later). \
Run the script: `/bin/bash voxelwiseAnalyses/finite_impulse_response/e152_PreGLM_noBlur.sh` \
FD to mask TRs is 0.5. Jo ran an analysis and found out that even with 0.5 (instead of 0.9), there are not a lot of bad frames!
## Prepare event files
To prepare input to AFNI to run FIR, we need events (regressors of interest). Event boundary has two grains, fine and coarse. Segmentation data was generated by Tan Nguyen on 08/15/2023 by running `Box\DCL_ARCHIVE\Documents\Events\exp152_fMRIneuralmechanisms\Analysis\analyze_session_two.ipynb`. This has two more subjects (sub-38&43) compared to the 07/11/2022 version (`Box\DCL_ARCHIVE\Documents\Events\exp152_fMRIneuralmechanisms\Analysis\segmentation.csv`) \
Events file were created by running `voxelwiseAnalyses/finite_impulse_response/afni_events_from_segmentation.ipynb`, which generate event files to `voxelwiseAnalyses/finite_impulse_response/EVTs/` \
For runs that should be excluded from GLMs or do not have boundary data from participants, they receive an "*" in the event files. This approach is consistent with the strategy to preprocess all subjects/sessions, and filter out people in real analysis

# Run GLMs with AFNI, then average voxels within a parcel
The GLM template is copied from `/data/nil-bluearc/ccp-hcp/StroopCW/CODE/GLMcode/GLMs_vol.R` to `voxelwiseAnalyses/finite_impulse_response/GLMs_vol_TENT_20.R`, then it's adapted to work with fMRI152 data. This script define a function to run GLMs for each voxel, and a function to perform parcel average for the output STATS from AFNI. This script is called by executing `voxelwiseAnalyses/finite_impulse_response/runGLMs_fMRI_Jo.R`, which is a high-level script to run call `GLMs_vol_TENT_20.R` and log results \
Results are saved at `voxelwiseAnalyses/finite_impulse_response/AFNI_ANALYSIS/sub-02/RESULTS_TENT20/` 
## Design Matrices
For each "event" (a fine boundary or a coarse boundary), we are interested in 10 seconds before the boundary and 20 seconds after the boundary. Thus, we used TENT(-10, 20, 16): 16 knots, 2s interval, from -10s to 20s of the "event" \
We run GLMs for each voxel with three design matrices: 

- A design matrix with only fine event boundaries. This analysis identifies voxels responsive to fine event boundaries, by looking at coefficients of 16 knots. 
- A design matrix with only coarse event boundaries. This analysis identifies voxels responsive to coarse event boundaries, by looking at coefficients of 16 knots. 
- A design matrix with both coarse and fine event boundaries. The above analyses might be confounded. The idea is that, conceptually coarse event segmentation (e.g. making coffee -> preparing a bagel) usually encloses or coincides with fine segmentation (e.g. pouring coffee to the cup -> fetching a bagel from a drawer). Suppose there's a brain region that is "sensitive only to fine event boundaries," when we run GLMs separately (with the two analyses above), we'll likely see this brain region responding to both fine event boundaries and coarse event boundaries (high coefficients). Conversely, a brain region that is only responsive to coarse boundaries can also have high coefficients in the fine event boundary analysis. This analysis tries to parcel out the correlation between fine event boundaries and coarse event boundaries. A drawback is that a high correlation between fine event boundaries and coarse event boundaries can reduce statistical power a lot.
# Visualize Results
AFNI output a lot of statistics, we are interested in the temporal shape of coefficients of regressors of interest (knots). We use `voxelwiseAnalyses/finite_impulse_response/knitr/timecourses_TENT20/group_GLMs_noBlur_timecourses_TENT20_meanSEM_sep.rnw` to visualize the median and SEM of coefficients for all subjects, modeling fine and coarse boundaries separately. We use `voxelwiseAnalyses/finite_impulse_response/knitr/timecourses_TENT20/group_GLMs_noBlur_timecourses_TENT20_meanSEM.rnw` to visualize coefficients when we model fine and coarse boundaries simultaneously.